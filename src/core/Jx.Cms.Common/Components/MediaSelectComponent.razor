@namespace Jx.Cms.Common.Components
@using System.Diagnostics
@using System.IO
@using System.Text
@using Jx.Cms.Common.Utils
@using Jx.Cms.Common.Vo
@using BootstrapBlazor.Components
@using Furion
@using Jx.Cms.Common.Enum
@using Masuit.Tools

@implements IResultDialog

@inject ToastService ToastService
@inject MessageService MessageService

<Row>
    <ButtonUpload TValue="string" BrowserButtonText="上传新媒体文件" IsMultiple="true" ShowProgress="true" OnChange="@OnClickToUpload" OnDelete="@(fileName => Task.FromResult(true))"></ButtonUpload>
</Row>
<Row ItemsPerRow="ItemsPerRow.One">
    已选中 @MediaInfoVos.Count(x => x.IsSelected) 个媒体文件
    <ListView TItem="MediaInfoVo" Items="@MediaInfoVos" OnListViewItemClick="OnListViewItemClick">
        <BodyTemplate>
            <Card Color="context.IsSelected ? Color.Dark : Color.None" IsCenter="true">
                <CardHeader>
                    @context.MediaName
                </CardHeader>
                <CardBody>
                    @if (context.MediaType == MediaTypeEnum.Image)
                    {
                        <img style="margin-bottom: 1rem" src="@context.Url?width=150&height=200" alt="@context.MediaName"/>
                    }
                    else if (context.MediaType == MediaTypeEnum.Audio)
                    {
                        <i style="width: 150px;height: 200px" class="fa fa-file-audio-o fa-5x"></i>
                    }
                    else if (context.MediaType == MediaTypeEnum.Video)
                    {
                        <i style="width: 150px;height: 200px" class="fa fa-file-video-o fa-5x"></i>
                    }
                    else
                    {
                        @("未知类型")
                    }
                </CardBody>
            </Card>
        </BodyTemplate>
    </ListView>
</Row>

@code {
    /// 要搜索的文件类型
    [Parameter]
    public string[] FileType { get; set; } = { ".jpg", ".jpeg", ".png", ".gif", ".mp3", ".mp4", ".wav", ".webm" };

    /// 选择事件
    [Parameter]
    public EventCallback<string> MediaSelected { get; set; }

    private List<MediaInfoVo> MediaInfoVos { get; set; }
    
    protected override void OnInitialized()
    {
        base.OnInitialized();
        MediaInfoVos = Util.GetUploadFile(FileType);
    }

    public async Task<bool> OnClosing(DialogResult result)
    {
        var ret = true;
        if (result == DialogResult.Yes && !MediaInfoVos.Any(x => x.IsSelected))
        {
            await MessageService.Show(new MessageOption()
            {
                Content = "请至少选择一个媒体文件！"
            });
            ret = false;
        }
        return ret;
    }

    public async Task OnClose(DialogResult result)
    {
        if (result == DialogResult.Yes)
        {
            StringBuilder sb = new StringBuilder();
            var selectMedia = MediaInfoVos.Where(x => x.IsSelected);
            foreach (var mediaInfoVo in selectMedia)
            {
                switch (mediaInfoVo.MediaType)
                {
                    case MediaTypeEnum.Image:
                        sb.AppendLine($"<img src={mediaInfoVo.Url} alt={mediaInfoVo.MediaName}></img>");
                        break;
                    case MediaTypeEnum.Video:
                        sb.AppendLine($@"<video src='{mediaInfoVo.Url}' controls='controls'>
                        您的浏览器不支持 video 标签。
                        </video>");
                        break;
                    case MediaTypeEnum.Audio:
                        sb.AppendLine($@"<audio src='{mediaInfoVo.Url}'>
                        您的浏览器不支持 audio 标签。
                        </audio>");
                        break;
                    case MediaTypeEnum.Unknow:
                        sb.AppendLine(mediaInfoVo.Url);
                        break;
                    default:
                        throw new ArgumentOutOfRangeException();
                }
            }
            await MediaSelected.InvokeAsync(sb.ToString());
        }
    }

    private Task OnListViewItemClick(MediaInfoVo arg)
    {
        arg.IsSelected = !arg.IsSelected;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private Task OnClickToUpload(UploadFile file)
    {
        if (!FileType.Any(x => x.Contains(Path.GetExtension(file.OriginFileName ?? ""))))
        {
            ToastService.Error($"不支持的文件类型，目前只支持{FileType.Join()}类型的文件");
            return Task.CompletedTask;
        }
        var dir = Path.Combine(App.WebHostEnvironment.WebRootPath, "upload", DateTime.Now.ToString("yyyyMMdd"));
        if (!Directory.Exists(dir))
        {
            Directory.CreateDirectory(dir);
        }
        var fileName = Path.Combine(dir, Stopwatch.GetTimestamp().ToBinary(8) + Path.GetExtension(file.OriginFileName));
        file.SaveToFile(fileName);
        MediaInfoVos = Util.GetUploadFile(FileType);
        StateHasChanged();
        return Task.CompletedTask;
    }

}